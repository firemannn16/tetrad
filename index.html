<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –∞—Ä–∞–±—Å–∫–∏—Ö —Å–ª–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            direction: ltr;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .format-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .format-label {
            font-size: 15px;
            color: #333;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #45a049;
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }

        .words-list {
            margin-bottom: 30px;
        }

        .word-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s;
            touch-action: pan-y;
        }

        .word-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            cursor: pointer;
        }

        .word-left {
            text-align: left;
            font-size: 18px;
            color: #333;
        }

        .word-right {
            text-align: right;
            font-size: 24px;
            color: #333;
            direction: rtl;
        }

        .word-right.multiple-formats {
            font-size: 20px;
        }

        .hidden {
            color: transparent;
            text-shadow: 0 0 8px rgba(0,0,0,0.5);
            user-select: none;
        }

        .pagination {
            text-align: center;
            margin-top: 20px;
        }

        .pagination button {
            background: #2196F3;
            margin: 0 5px;
        }

        .error-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .error-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .error-controls button {
            background: #ff9800;
        }

        .errors-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .errors-box::-webkit-scrollbar {
            width: 10px;
        }

        .errors-box::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .errors-box::-webkit-scrollbar-thumb {
            background: #000;
            border-radius: 5px;
        }

        .error-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .management-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .management-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .management-controls button {
            background: #9C27B0;
        }

        .show-code-btn {
            background: #ff5722 !important;
        }

        .code-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .code-display h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .code-value {
            font-size: 32px;
            font-weight: bold;
            color: #ff5722;
            letter-spacing: 5px;
            margin: 10px 0;
        }

        .code-display button {
            background: #ff5722;
            margin-top: 10px;
        }

        .code-input-section {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .code-input-section input {
            font-size: 24px;
            padding: 10px;
            border: 2px solid #2196F3;
            border-radius: 5px;
            text-align: center;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin: 10px 0;
        }

        .code-input-section button {
            background: #2196F3;
            font-size: 16px;
            padding: 10px 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåô –¢—Ä–µ–Ω–∞–∂–µ—Ä –∞—Ä–∞–±—Å–∫–∏—Ö —Å–ª–æ–≤</h1>
        
        <div id="codeDisplay" class="code-display" style="display: none;">
            <h2>‚ö†Ô∏è –í–ê–® –ö–û–î –î–û–°–¢–£–ü–ê - –°–û–•–†–ê–ù–ò–¢–ï –ï–ì–û!</h2>
            <div class="code-value" id="codeValue"></div>
            <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ —Å –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤!</p>
            <button onclick="copyCode()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <button onclick="hideCodeDisplay()">‚úÖ –ü–æ–Ω—è—Ç–Ω–æ, –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
        </div>

        <div id="codeInput" class="code-input-section" style="display: none;">
            <h2>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–¥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h2>
            <input type="text" id="codeInputField" placeholder="AB7K9M" maxlength="6">
            <br>
            <button onclick="loadProgressByCode()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>

        <div class="management-section">
            <div class="management-controls">
                <button onclick="addNewWords()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞</button>
                <button onclick="confirmReset()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                <button class="show-code-btn" onclick="showMyCode()">üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π –∫–æ–¥</button>
            </div>
        </div>

        <div class="controls">
            <div class="format-toggle">
                <span class="format-label">–§–æ—Ä–º–∞—Ç: <strong id="formatDisplay">–ê–†–ë - –†–£–°</strong></span>
                <button onclick="toggleFormat()">‚áÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>

        <div class="stats">
            <span>–í–°–ï–ì–û: <strong id="totalWords">0</strong></span> | 
            <span>–û–°–¢–ê–õ–û–°–¨ –ü–†–û–ô–¢–ò: <strong id="remainingWords">0</strong></span>
        </div>

        <div class="words-list" id="wordsList"></div>

        <div class="pagination">
            <button onclick="nextPage()" id="nextPageBtn" style="display: none;">–°–ª–µ–¥—É—é—â–∏–µ —Å–ª–æ–≤–∞ ‚Üí</button>
        </div>

        <div class="error-section">
            <h3>‚ùå –û—à–∏–±–∫–∏:</h3>
            <div class="error-controls">
                <button onclick="copyErrors()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏</button>
                <button onclick="returnErrors()">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–∞</button>
            </div>
            <div class="errors-box" id="errorsBox">
                <p style="color: #999;">–ù–µ—Ç –æ—à–∏–±–æ–∫</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCs65we9V9cw9IHkar6D5LH5VSHlB3WHbY",
            authDomain: "tetrad-3ae7e.firebaseapp.com",
            projectId: "tetrad-3ae7e",
            storageBucket: "tetrad-3ae7e.firebasestorage.app",
            messagingSenderId: "397016124442",
            appId: "1:397016124442:web:bf2fb9170d3d9e68c355a3",
            measurementId: "G-CH0YW98L55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firestoreUpdateDoc = updateDoc;

        let allWords = [];
        let currentPage = 0;
        let wordsPerPage = 100;
        let isArabicToRussian = true;
        let userCode = '';
        let isNewUser = false;

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ —Å –ª—é–±—ã–º–∏ –≤–∏–¥–∞–º–∏ —Ç–∏—Ä–µ
        function parseLine(line) {
            if (!line || !line.trim()) return null;
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –∞—Ä–∞–±—Å–∫–∏–π —Å–∏–º–≤–æ–ª (–¥–∏–∞–ø–∞–∑–æ–Ω Unicode –¥–ª—è –∞—Ä–∞–±—Å–∫–æ–≥–æ)
            const arabicMatch = line.match(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/);
            if (!arabicMatch) return null;
            
            const arabicStart = line.indexOf(arabicMatch[0]);
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —Ä—É—Å—Å–∫—É—é –∏ –∞—Ä–∞–±—Å–∫—É—é —á–∞—Å—Ç–∏
            let russianPart = line.substring(0, arabicStart);
            let arabicPart = line.substring(arabicStart);
            
            // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —Ç–∏—Ä–µ –≤ –∫–æ–Ω—Ü–µ —Ä—É—Å—Å–∫–æ–π —á–∞—Å—Ç–∏ (–≤—Å–µ –≤–∏–¥—ã: -, ‚Äì, ‚Äî, ‚Äï)
            russianPart = russianPart.replace(/[\s\-\‚Äì\‚Äî\‚Äï]+$/, '').trim();
            arabicPart = arabicPart.trim();
            
            if (!russianPart || !arabicPart) return null;
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã (–≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π –¥–µ—Ñ–∏—Å —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
            const russianVariants = russianPart.split(/\s*[-‚Äì‚Äî‚Äï]\s*/).map(p => p.trim()).filter(p => p);
            const arabicVariants = arabicPart.split(/\s*-\s*/).map(p => p.trim()).filter(p => p);
            
            return {
                russian: russianVariants,
                arabic: arabicVariants,
                id: line.trim(),
                opened: false,
                error: false
            };
        }

        async function saveToFirebase() {
            if (!userCode) return;
            
            const openedWords = {};
            allWords.forEach(word => {
                if (word.opened) {
                    openedWords[word.id] = true;
                }
            });

            const errors = allWords
                .filter(w => w.error)
                .map(w => ({ ru: w.russian.join(' - '), ar: w.arabic.join(' - ') }));

            const data = {
                initialWordCount: parseInt(localStorage.getItem('arabicTrainer_initialWordCount')) || 0,
                openedWords: openedWords,
                errors: errors,
                lastSaved: new Date().toISOString()
            };

            try {
                await window.firestoreSetDoc(window.firestoreDoc(window.db, 'users', userCode), data);
                console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Firebase');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
            }
        }

        async function loadFromFirebase(code) {
            try {
                const docRef = window.firestoreDoc(window.db, 'users', code);
                const docSnap = await window.firestoreGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    localStorage.setItem('arabicTrainer_userCode', code);
                    localStorage.setItem('arabicTrainer_initialWordCount', data.initialWordCount);
                    localStorage.setItem('arabicTrainer_openedWords', JSON.stringify(data.openedWords));
                    localStorage.setItem('arabicTrainer_errors', JSON.stringify(data.errors));
                    
                    userCode = code;
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Firebase');
                    return true;
                } else {
                    alert('‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                return false;
            }
        }

        window.copyCode = function() {
            navigator.clipboard.writeText(userCode);
            alert('‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + userCode);
        }

        window.showMyCode = function() {
            if (userCode) {
                const message = `üîë –í–ê–® –ö–û–î:\n\n${userCode}\n\n–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –¥–ª—è –≤—Ö–æ–¥–∞ —Å –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤!`;
                alert(message);
                navigator.clipboard.writeText(userCode);
            }
        }

        window.hideCodeDisplay = function() {
            document.getElementById('codeDisplay').style.display = 'none';
        }

        window.loadProgressByCode = async function() {
            const input = document.getElementById('codeInputField');
            const code = input.value.trim().toUpperCase();
            
            if (code.length !== 6) {
                alert('‚ùå –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            const loaded = await loadFromFirebase(code);
            if (loaded) {
                document.getElementById('codeInput').style.display = 'none';
                await init();
            }
        }

        async function init() {
            userCode = localStorage.getItem('arabicTrainer_userCode');
            
            if (!userCode) {
                document.getElementById('codeInput').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('words.txt');
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                const initialWordCount = parseInt(localStorage.getItem('arabicTrainer_initialWordCount'));
                
                if (!initialWordCount) {
                    const wasReset = localStorage.getItem('arabicTrainer_wasReset') === 'true';
                    
                    localStorage.setItem('arabicTrainer_initialWordCount', lines.length);
                    
                    // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é parseLine
                    allWords = lines.map(line => parseLine(line)).filter(word => word !== null);
                    allWords = shuffle(allWords);
                    
                    if (!wasReset) {
                        document.getElementById('codeDisplay').style.display = 'block';
                        document.getElementById('codeValue').textContent = userCode;
                        isNewUser = true;
                    }
                    
                    localStorage.removeItem('arabicTrainer_wasReset');
                } else {
                    const wordsToLoad = lines.slice(0, initialWordCount);
                    
                    // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é parseLine
                    allWords = wordsToLoad.map(line => parseLine(line)).filter(word => word !== null);
                    allWords = shuffle(allWords);
                    
                    const openedWords = JSON.parse(localStorage.getItem('arabicTrainer_openedWords') || '{}');
                    const errors = JSON.parse(localStorage.getItem('arabicTrainer_errors') || '[]');
                    
                    allWords.forEach(word => {
                        if (openedWords[word.id]) {
                            word.opened = true;
                        }
                        if (errors.some(e => e.ru === word.russian.join(' - ') && e.ar === word.arabic.join(' - '))) {
                            word.error = true;
                        }
                    });
                }
                
                renderWords();
                updateStats();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤:', error);
            }
        }

        function renderWords() {
            const wordsList = document.getElementById('wordsList');
            const start = currentPage * wordsPerPage;
            const pageWords = allWords.filter(w => !w.error).slice(start, start + wordsPerPage);
            
            wordsList.innerHTML = '';
            pageWords.forEach((word, index) => {
                const item = document.createElement('div');
                item.className = 'word-item';
                
                const content = document.createElement('div');
                content.className = 'word-content';
                
                const leftSide = document.createElement('div');
                leftSide.className = 'word-left';
                
                const rightSide = document.createElement('div');
                rightSide.className = 'word-right';
                
                if (isArabicToRussian) {
                    if (word.arabic.length > 2) {
                        rightSide.classList.add('multiple-formats');
                    }
                    rightSide.textContent = word.arabic.join(' - ');
                    leftSide.textContent = word.russian.join('\n');
                    
                    if (!word.opened) {
                        leftSide.classList.add('hidden');
                        leftSide.textContent = '**********';
                    }
                } else {
                    if (word.arabic.length > 2) {
                        rightSide.classList.add('multiple-formats');
                    }
                    leftSide.textContent = word.russian.join('\n');
                    rightSide.textContent = word.arabic.join(' - ');
                    
                    if (!word.opened) {
                        rightSide.classList.add('hidden');
                        rightSide.textContent = '**********';
                    }
                }
                
                content.appendChild(leftSide);
                content.appendChild(rightSide);
                item.appendChild(content);
                wordsList.appendChild(item);
                
                let startX = 0;
                let currentX = 0;
                
                item.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                });
                
                item.addEventListener('touchmove', (e) => {
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    if (diff > 0) {
                        item.style.transform = `translateX(${diff}px)`;
                    }
                });
                
                item.addEventListener('touchend', () => {
                    const diff = currentX - startX;
                    if (diff > 100) {
                        word.error = true;
                        saveState();
                        renderWords();
                        renderErrors();
                        updateStats();
                    }
                    item.style.transform = '';
                    startX = 0;
                    currentX = 0;
                });
                
                content.addEventListener('click', () => {
                    word.opened = true;
                    saveState();
                    renderWords();
                    updateStats();
                });
            });
            
            const remainingWords = allWords.filter(w => !w.error).length - (start + wordsPerPage);
            const nextBtn = document.getElementById('nextPageBtn');
            if (remainingWords > 0) {
                nextBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'none';
            }
            
            renderErrors();
        }

        function renderErrors() {
            const errorsBox = document.getElementById('errorsBox');
            const errorWords = allWords.filter(w => w.error);
            
            if (errorWords.length === 0) {
                errorsBox.innerHTML = '<p style="color: #999;">–ù–µ—Ç –æ—à–∏–±–æ–∫</p>';
            } else {
                errorsBox.innerHTML = errorWords.map(w => 
                    `<div class="error-item">${w.russian.join(' - ')} ‚Äî ${w.arabic.join(' - ')}</div>`
                ).join('');
            }
        }

        function saveState() {
            const openedWords = {};
            allWords.forEach(word => {
                if (word.opened) {
                    openedWords[word.id] = true;
                }
            });
            
            const errors = allWords
                .filter(w => w.error)
                .map(w => ({ ru: w.russian.join(' - '), ar: w.arabic.join(' - ') }));
            
            localStorage.setItem('arabicTrainer_openedWords', JSON.stringify(openedWords));
            localStorage.setItem('arabicTrainer_errors', JSON.stringify(errors));
            
            saveToFirebase();
        }

        function updateStats() {
            const total = allWords.length;
            const remaining = allWords.filter(w => !w.error && !w.opened).length;
            
            document.getElementById('totalWords').textContent = total;
            document.getElementById('remainingWords').textContent = remaining;
            document.getElementById('formatDisplay').textContent = isArabicToRussian ? '–ê–†–ë - –†–£–°' : '–†–£–° - –ê–†–ë';
        }

        window.toggleFormat = function() {
            isArabicToRussian = !isArabicToRussian;
            renderWords();
            updateStats();
        }

        window.nextPage = function() {
            currentPage++;
            renderWords();
            window.scrollTo(0, 0);
        }

        window.copyErrors = function() {
            const errorWords = allWords.filter(w => w.error);
            if (errorWords.length === 0) {
                alert('–ù–µ—Ç –æ—à–∏–±–æ–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            const text = errorWords.map(w => 
                `${w.russian.join(' - ')} ‚Äî ${w.arabic.join(' - ')}`
            ).join('\n');
            
            navigator.clipboard.writeText(text);
            alert('‚úÖ –û—à–∏–±–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!');
        }

        window.returnErrors = function() {
            const errorWords = allWords.filter(w => w.error);
            if (errorWords.length === 0) {
                alert('–ù–µ—Ç –æ—à–∏–±–æ–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞');
                return;
            }
            
            errorWords.forEach(word => {
                word.error = false;
                word.opened = false;
            });
            
            saveState();
            renderWords();
            updateStats();
            alert(`‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ —Å–ª–æ–≤: ${errorWords.length}`);
        }

        window.addNewWords = async function() {
            try {
                const response = await fetch('words.txt');
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                const currentCount = parseInt(localStorage.getItem('arabicTrainer_initialWordCount'));
                const newWordsLines = lines.slice(currentCount);
                
                if (newWordsLines.length === 0) {
                    alert('‚ùå –ù–æ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ—Ç!');
                    return;
                }
                
                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é parseLine
                const newWords = newWordsLines.map(line => parseLine(line)).filter(word => word !== null);
                
                allWords = [...allWords, ...shuffle(newWords)];
                localStorage.setItem('arabicTrainer_initialWordCount', lines.length);
                
                saveState();
                renderWords();
                updateStats();
                
                alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤: ${newWords.length}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤');
            }
        }

        window.confirmReset = function() {
            if (confirm('‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´?\n\n–í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω:\n- –û—Ç–∫—Ä—ã—Ç—ã–µ —Å–ª–æ–≤–∞\n- –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫\n- –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 1\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–õ–¨–ó–Ø –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                resetProgress();
            }
        }

        async function resetProgress() {
            const existingCode = userCode;
            
            localStorage.setItem('arabicTrainer_wasReset', 'true');
            
            const wasReset = localStorage.getItem('arabicTrainer_wasReset');
            localStorage.clear();
            localStorage.setItem('arabicTrainer_wasReset', wasReset);
            
            localStorage.setItem('arabicTrainer_userCode', existingCode);
            userCode = existingCode;
            
            try {
                await window.firestoreSetDoc(window.firestoreDoc(window.db, 'users', userCode), {
                    initialWordCount: 0,
                    openedWords: {},
                    errors: [],
                    lastSaved: new Date().toISOString()
                });
                console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—á–∏—â–µ–Ω –≤ Firebase');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ Firebase:', error);
            }
            
            currentPage = 0;
            location.reload();
        }

        if (!localStorage.getItem('arabicTrainer_userCode')) {
            userCode = generateCode();
            localStorage.setItem('arabicTrainer_userCode', userCode);
        }
        
        init();
    </script>
</body>
</html>
